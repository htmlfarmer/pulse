<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>News Study Map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <style>
      html,body,#map { height: 100%; margin: 0; padding: 0 }
      .news-popup { max-width: 360px; }
      .news-title { font-weight: 600; margin-bottom: 6px; }
      .news-source { color: #666; font-size: 90%; }
      .news-summary { margin-top: 6px; }
    </style>
  </head>
  <body>
    <div id="controls" style="position: absolute; z-index: 1000; bottom: 12px; left: 50%; transform: translateX(-50%); background: rgba(255,255,255,0.95); padding:8px; border-radius:6px; box-shadow:0 1px 4px rgba(0,0,0,0.2); display:flex; align-items:center; gap:10px">
  <label for="dateRange">Date:</label>
      <select id="dateRange">
        <option value="all">All</option>
        <option value="1d">Last day</option>
        <option value="7d">Last week</option>
        <option value="30d">Last month</option>
        <option value="365d">Last year</option>
      </select>
      <label for="sinceYear">Since year:</label>
      <select id="sinceYear">
        <option value="all">All</option>
      </select>
      <label for="maxItems">Max items: <span id="maxItemsVal">1000</span></label>
      <input id="maxItems" type="range" min="10" max="10000" step="10" value="1000" style="vertical-align:middle; width:200px">
      <label for="wikiPer">Wiki/item: <span id="wikiPerVal">1</span></label>
      <input id="wikiPer" type="range" min="0" max="5" step="1" value="1" style="vertical-align:middle; width:120px">
      <div id="refreshStatus" style="margin-left:8px; min-width:120px; text-align:left"></div>
    </div>

    <!-- right-side live status panel -->
    <div id="statusPanel" style="position:absolute; right:10px; top:10px; bottom:10px; width:340px; background: rgba(255,255,255,0.95); padding:8px; border-radius:6px; box-shadow:0 1px 8px rgba(0,0,0,0.25); overflow:auto; font-family:monospace; font-size:12px;">
      <div style="display:flex; justify-content:space-between; align-items:center"><div style="font-weight:600; margin-bottom:6px">Live status</div><button id="livePulseBtn" style="padding:6px 8px;">Live Pulse</button></div>
      <div style="margin-bottom:8px"><strong>Sources</strong><div id="sourcesList" style="margin-top:6px"></div></div>
      <div style="font-weight:600; margin-bottom:6px">Recent features</div>
      <pre id="statusLog" style="white-space:pre-wrap; margin:0; height:240px; overflow:auto">(no log yet)</pre>
    </div>

    <div id="map"></div>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script>
      const map = L.map('map').setView([20,0], 2);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '© OpenStreetMap contributors'
      }).addTo(map);

      const markers = L.markerClusterGroup({chunkedLoading: true});
      let allFeatures = [];
      let currentMarkers = null;

      function parseDate(s){
        if(!s) return null;
        let d = new Date(s);
        if(!isNaN(d)) return d;
        d = Date.parse(s);
        return isNaN(d)? null : new Date(d);
      }

      function applyFilters(){
        const range = document.getElementById('dateRange').value;
        const maxItems = parseInt(document.getElementById('maxItems').value,10) || 1000;
        const cutoff = (function(){
          if(range==='all') return null;
          const now = Date.now();
          const days = parseInt(range.replace('d',''))||0;
          return new Date(now - days*24*3600*1000);
        })();

        if(currentMarkers){ map.removeLayer(currentMarkers); }
        const m = L.markerClusterGroup({chunkedLoading: true});

        let filtered = allFeatures.filter(f=>{
          if(!f || !f.properties) return false;
          if(!f.geometry || !f.geometry.coordinates) return false;
          if(cutoff){
            const p = f.properties;
            const pub = p.published || p.date || null;
            const d = parseDate(pub);
            if(!d) return false;
            if(d < cutoff) return false;
          }
          // sinceYear filter (works with year dropdown)
          const sy = document.getElementById('sinceYear').value || 'all';
          if(sy !== 'all'){
            const p2 = f.properties;
            const pub2 = p2.published || p2.date || null;
            const d2 = parseDate(pub2);
            if(!d2) return false;
            if(d2.getFullYear() < parseInt(sy,10)) return false;
          }
          return true;
        });

        filtered = filtered.slice(0, maxItems);

        filtered.forEach(f=>{
          try{
            const coords = f.geometry.coordinates;
            const lon = coords[0], lat = coords[1];
            const props = f.properties||{};
            const title = props.title || props.place || 'News item';
            const place = props.place || '';
            const news_source = props.news_source || props.source || '';
            const news_link = props.news_link || props.link || '#';
            const summary = (props.summary || '').replace(/\n/g,' ').slice(0,800);
            // show news link first (with a News label), then related wikipedia matches if present
            let newsDomain = '';
            try{ newsDomain = (new URL(news_link)).hostname; }catch(e){ newsDomain = news_source || ''; }
            let wikiHtml = '';
            const wikiMatches = Array.isArray(props.wiki_matches) ? props.wiki_matches : [];
            const showWiki = Math.max(0, parseInt(document.getElementById('wikiPer').value || '1', 10));
            if(wikiMatches.length > 0 && showWiki > 0){
              wikiHtml = '<div style="margin-top:8px;font-weight:600">Related Wikipedia:</div><ul style="margin:6px 0;padding-left:18px">';
              wikiMatches.slice(0, showWiki).forEach(w=>{
                // skip identical links
                if(w.link === news_link) return;
                wikiHtml += `<li><a href="${w.link}" target="_blank" rel="noopener noreferrer">${escapeHtml(w.title || w.link)}</a> ${w.summary?('<div style="font-size:90%;color:#444">'+escapeHtml(w.summary.slice(0,140))+'</div>'):''}</li>`;
              });
              wikiHtml += '</ul>';
            }
            const html = `<div class="news-popup"><div style="font-size:90%;color:#666;margin-bottom:6px"><strong>News</strong> — ${escapeHtml(newsDomain)}</div><div class="news-title"><a href="${news_link}" target="_blank" rel="noopener noreferrer">${escapeHtml(title)}</a></div><div class="news-source">${place?('&middot; '+escapeHtml(place)):''}</div><div class="news-summary">${escapeHtml(summary)}</div><div style="margin-top:6px"><a href="${news_link}" target="_blank" rel="noopener noreferrer">Open article</a></div>${wikiHtml}</div>`;
            const marker = L.marker([lat, lon]);
            marker.bindPopup(html);
            m.addLayer(marker);
            // log in status panel for quick debugging (first few)
            try{ if(filtered.indexOf(f) < 8){ statusLog.textContent = `${statusLog.textContent}\n[${filtered.indexOf(f)}] ${title} -- ${news_source} -- ${news_link} -- ${place}`; statusLog.parentElement.scrollTop = statusLog.parentElement.scrollHeight; } }catch(e){}
          }catch(e){console.error('feature error',e);}          
        });
  currentMarkers = m;
  map.addLayer(m);
  // diagnostic: show how many markers were added
  try{ statusEl.textContent = `Markers shown: ${filtered.length}`; }catch(e){}
  if(m.getBounds && m.getBounds().isValid && m.getBounds().isValid()) map.fitBounds(m.getBounds(), {maxZoom: 10});
      }

      fetch('data/articles.geojson').then(r=>r.json()).then(geo=>{
        if(!geo || !geo.features) return;
        allFeatures = geo.features.map(f=>{
          if(f.properties && !f.properties.published){
            f.properties.published = f.properties.published || f.properties.date || null;
          }
          return f;
        });
        const maxItemsInput = document.getElementById('maxItems');
        const maxVal = Math.max(100, allFeatures.length);
        maxItemsInput.max = Math.min(10000, Math.max(maxVal, 1000));
        maxItemsInput.value = Math.min(1000, allFeatures.length);
        document.getElementById('maxItemsVal').textContent = maxItemsInput.value;

        // populate sinceYear dropdown (years seen in published dates)
        try{
          const years = new Set();
          allFeatures.forEach(f=>{ const p = f.properties || {}; const pub = p.published || p.date || null; const d = parseDate(pub); if(d) years.add(d.getFullYear()); });
          const sy = document.getElementById('sinceYear');
          const sorted = Array.from(years).sort((a,b)=>b-a);
          sorted.forEach(y=>{ const opt = document.createElement('option'); opt.value = String(y); opt.textContent = String(y); sy.appendChild(opt); });
        }catch(e){}

        // diagnostics: show loaded feature count and a sample
        try{
          const sample = allFeatures[0];
          const sampleInfo = sample ? `${sample.properties && sample.properties.title ? sample.properties.title : '(no title)'} @ ${sample.geometry && sample.geometry.coordinates ? sample.geometry.coordinates.join(',') : '(no coords)'}` : '(no features)';
          statusEl.textContent = `Loaded ${allFeatures.length} features`;
          statusLog.textContent = `Loaded ${allFeatures.length} features\nSample: ${sampleInfo}\n\n` + (statusLog.textContent || '');
          console.info('Loaded features:', allFeatures.length, sampleInfo);
        }catch(e){ console.error('diag', e); }

        // populate sources list (unique news_source domains)
        try{
          const sources = new Map();
          allFeatures.forEach(f=>{ const p = f.properties || {}; const s = p.news_source || p.source || ''; if(s && !sources.has(s)) sources.set(s,s); });
          const srcDiv = document.getElementById('sourcesList');
          srcDiv.innerHTML = '';
          Array.from(sources.keys()).forEach(s=>{
            const id = 'src_'+s.replace(/[^a-z0-9]/gi,'_');
            const cb = document.createElement('input'); cb.type='checkbox'; cb.id = id; cb.checked = true; cb.value = s;
            const lbl = document.createElement('label'); lbl.htmlFor = id; lbl.style.display='block'; lbl.style.fontSize='12px'; lbl.style.marginBottom='2px'; lbl.appendChild(cb); lbl.appendChild(document.createTextNode(' '+s));
            srcDiv.appendChild(lbl);
          });
          // make checkboxes filter the map immediately when toggled
          srcDiv.querySelectorAll('input[type=checkbox]').forEach(cb=> cb.addEventListener('change', ()=> applyFilters()));
        }catch(e){console.error(e);} 

        applyFilters();

          // when date range changes, also trigger a background refresh (debounced)
          let refreshTimer = null;
          const statusEl = document.getElementById('refreshStatus');
          const statusLog = document.getElementById('statusLog');

          // start polling the pulse.log file for live updates
          let lastLog = '';
          function pollLog(){
            fetch('data/pulse.log', {cache:'no-store'}).then(r=>{
              if(!r.ok) throw new Error('no log');
              return r.text();
            }).then(text=>{
              if(text !== lastLog){
                lastLog = text;
                statusLog.textContent = text || '(empty)';
                // keep the panel scrolled to bottom
                statusLog.parentElement.scrollTop = statusLog.parentElement.scrollHeight;
              }
            }).catch(()=>{/*ignore*/}).finally(()=> setTimeout(pollLog, 3000));
          }
          pollLog();

          document.getElementById('dateRange').addEventListener('change', (e)=>{
            applyFilters();
            if(refreshTimer) clearTimeout(refreshTimer);
            // debounce 1s then POST to trigger server
            refreshTimer = setTimeout(()=>{
              const wikiPerVal = parseInt(document.getElementById('wikiPer').value || '1',10) || 0;
              const sinceYearVal = document.getElementById('sinceYear').value || 'all';
              // collect selected sources
              const srcEls = Array.from(document.querySelectorAll('#sourcesList input[type=checkbox]'));
              const selected = srcEls.filter(x=>x.checked).map(x=>x.value);
              const payload = { limit: 10, max_places: 500, max_features: 2000, wiki_per_item: wikiPerVal, since_year: sinceYearVal, sources: selected };
              statusEl.textContent = 'Refreshing…';
              const liveBtn = document.getElementById('livePulseBtn');
              if(liveBtn) liveBtn.disabled = true;
              // Only attempt to call the local trigger server when this page is loaded from localhost.
              function isLocalhost(){ try{ return location.hostname === 'localhost' || location.hostname === '127.0.0.1' || location.hostname === ''; }catch(e){return false;} }
              if(!isLocalhost()){
                statusEl.textContent = 'To regenerate, open admin.html on the server and trigger with your secret token.';
                if(liveBtn) liveBtn.disabled = false;
                return;
              }
              // NOTE: for security, the map UI does not include a trigger token. The admin page can be used for tokenized triggers.
              fetch('http://127.0.0.1:5050/trigger', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) })
                .then(r=>{
                  if(!r.ok) throw new Error('trigger failed');
                  // poll trigger server /log for a run end marker
                  const checkDone = async ()=>{
                    try{
                      const resp = await fetch('http://127.0.0.1:5050/log?lines=200', {cache:'no-store'});
                      if(!resp.ok) return false;
                      const j = await resp.json();
                      const txt = j.log || '';
                      return txt.includes('pulse run end');
                    }catch(e){ return false; }
                  };
                  const intervalId = setInterval(async ()=>{
                    const done = await checkDone();
                    if(done){
                      clearInterval(intervalId);
                      if(liveBtn) liveBtn.disabled = false;
                      // reload geojson and refresh
                      fetch('data/articles.geojson', {cache:'no-store'}).then(r=>r.json()).then(geo=>{
                        if(geo && geo.features){
                          allFeatures = geo.features.map(f=>{ if(f.properties && !f.properties.published){ f.properties.published = f.properties.published || f.properties.date || null; } return f; });
                          const maxItemsInput = document.getElementById('maxItems');
                          const maxVal = Math.max(100, allFeatures.length);
                          maxItemsInput.max = Math.min(10000, Math.max(maxVal, 1000));
                          maxItemsInput.value = Math.min(parseInt(maxItemsInput.value,10)||1000, allFeatures.length);
                          document.getElementById('maxItemsVal').textContent = maxItemsInput.value;
                          applyFilters();
                          statusEl.textContent = 'Updated'; setTimeout(()=>statusEl.textContent='','3000');
                        } else { statusEl.textContent = 'Updated (no features)'; setTimeout(()=>statusEl.textContent='','3000'); }
                      }).catch(err=>{ console.error('reload geojson',err); statusEl.textContent='Reload failed'; setTimeout(()=>statusEl.textContent='','3000'); });
                    }
                  }, 3000);
                }).catch(err=>{ console.error(err); statusEl.textContent = 'Refresh failed'; setTimeout(()=>statusEl.textContent='','3000'); if(liveBtn) liveBtn.disabled = false; });
            }, 1000);
          });
          maxItemsInput.addEventListener('input', (e)=>{ document.getElementById('maxItemsVal').textContent = e.target.value; applyFilters(); });
          document.getElementById('wikiPer').addEventListener('input', (e)=>{ document.getElementById('wikiPerVal').textContent = e.target.value; });
      }).catch(e=>console.error(e));

      // poll a URL for Last-Modified change, then call cb
      function pollForUpdate(url, interval, cb){
        let last = null;
        const check = ()=>{
          fetch(url, {method:'HEAD', cache:'no-store'}).then(r=>{
            const lm = r.headers.get('Last-Modified') || r.headers.get('ETag');
            if(!last) last = lm;
            if(lm && last && lm !== last){
              cb();
            } else {
              setTimeout(check, interval);
            }
          }).catch(()=> setTimeout(check, interval));
        };
        check();
      }

      function escapeHtml(s){
        if(!s) return '';
        return String(s)
          .replace(/&/g,'&amp;')
          .replace(/</g,'&lt;')
          .replace(/>/g,'&gt;')
          .replace(/"/g,'&quot;')
          .replace(/'/g,'&#39;');
      }
    </script>
  </body>
</html>
